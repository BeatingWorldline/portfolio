<!DOCTYPE html>
<html>
<head>
    <title>打开小程序</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script>
        window.onerror = e => {
            console.error(e)
            alert('发生错误' + e)
        }
    </script>
    <!-- WeUI CSS -->
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.4.1/weui.min.css">
    <!-- 微信 JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <!-- 云开发 Web SDK (必须引入才能实现免鉴权) -->
    <script src="https://res.wx.qq.com/open/js/cloudbase/1.1.0/cloud.js"></script>
    <script>
        function docReady(fn) {
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                fn()
            } else {
                document.addEventListener('DOMContentLoaded', fn);
            }
        }

        docReady(async function () {
            var ua = navigator.userAgent.toLowerCase()
            var isWXWork = ua.match(/wxwork/i) == 'wxwork'
            var isWeixin = !isWXWork && ua.match(/micromessenger/i) == 'micromessenger'
            
            if (isWeixin) {
                // 微信环境内
                var containerEl = document.getElementById('wechat-web-container')
                containerEl.classList.remove('hidden')
                containerEl.classList.add('full', 'wechat-web-container')

                var launchBtn = document.getElementById('launch-btn')
                launchBtn.addEventListener('ready', function (e) {
                    console.log('开放标签 ready')
                })
                launchBtn.addEventListener('launch', function (e) {
                    console.log('开放标签 success')
                })
                launchBtn.addEventListener('error', function (e) {
                    console.log('开放标签 fail', e.detail)
                })

                // 初始化云开发环境 (这是免鉴权的关键步骤)
                // 1. 必须引入 cloud.js (已在 head 中引入)
                // 2. 必须在云开发控制台 -> 静态网站托管 -> 部署此页面
                // 3. 必须使用云开发分配的域名访问 (或绑定的自定义域名)
                var c = new cloud.Cloud({
                    identityless: true,
                    resourceAppid: 'wxac0b60031891ca0c', // 资源方 AppID
                    resourceEnv: 'zhangzhicong-0ginpr154d8021ee', // ⚠️替换为真实的腾讯云环境ID
                })
                await c.init()

                // 云开发免鉴权不需要 wx.config，直接使用开放标签即可
                // 但为了保险起见，或者如果是非云开发域名，依然可能需要签名
                // 在云开发静态网站托管下，只要引入了 cloud.js 并 init，开放标签通常会自动生效
                // 如果依然报错 invalid signature，说明可能不在云托管域名下，或者必须走签名流程
                
                // 尝试配置 wx.config，但在云托管下参数可随意
                wx.config({
                    debug: true, 
                    appId: 'wxac0b60031891ca0c', 
                    timestamp: 0, 
                    nonceStr: 'nonceStr', 
                    signature: 'signature', 
                    jsApiList: ['chooseImage'], 
                    openTagList: ['wx-open-launch-weapp'], 
                })

                wx.ready(function () {
                    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
                    console.log('wx ready')
                    var btn = document.getElementById('launch-btn');
                    btn.addEventListener('launch', function (e) {
                        console.log('success');
                    });
                    btn.addEventListener('error', function (e) {
                        console.log('fail', e.detail);
                    });
                });

                wx.error(function (res) {
                    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                    console.log('wx error', res)
                });
            } else {
                // 非微信环境（PC浏览器、外部浏览器、其他App）统一显示提示
                var containerEl = document.getElementById('public-web-container')
                containerEl.classList.remove('hidden')
                containerEl.classList.add('full', 'public-web-container')
            }
        })
    </script>
    <style>
        .hidden {
            display: none;
        }

        .full {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .public-web-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .public-web-container p {
            position: absolute;
            top: 40%;
            text-align: center;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .wechat-web-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wechat-web-container p {
            position: absolute;
            top: 40%;
        }

        .wechat-web-container wx-open-launch-weapp {
            position: absolute;
            bottom: 40%;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="page full">
        <!-- 非微信环境提示容器 -->
        <div id="public-web-container" class="hidden">
            <p class="">请在微信客户端打开链接</p>
        </div>

        <!-- 微信内部跳转容器 -->
        <div id="wechat-web-container" class="hidden">
            <p class="">点击以下按钮打开“小美满小加餐”</p>
            <!-- username: 填入小程序原始账号ID（gh_开头） -->
            <!-- path: 填入要跳转到的页面路径 -->
            <wx-open-launch-weapp id="launch-btn" username="gh_c2a7424f942e" path="pages/index/index">
                <template>
                    <style>
                        .btn {
                            padding: 12px 24px;
                            width: 200px; 
                            height: 45px;
                            line-height: 45px;
                            text-align: center;
                            font-size: 17px; 
                            display: block; 
                            margin: 0 auto; 
                            border: none; 
                            border-radius: 4px;
                            background-color: #07c160;
                            color: #fff;
                        }
                    </style>
                    <button class="btn">打开小程序</button>
                </template>
            </wx-open-launch-weapp>
        </div>
    </div>
</body>
</html>